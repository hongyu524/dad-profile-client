<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dad Profile</title>
  <style>
    :root {
      --bg: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --card: #ffffff;
      --shadow: 0 10px 30px rgba(0,0,0,0.08);
      --btn: #111827;
      --btnText: #ffffff;
      --btn2: #f3f4f6;
      --btn2Text: #111827;
      --danger: #b91c1c;
      --ok: #065f46;
    }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 28px 16px;
    }
    .wrap {
      max-width: 760px;
      margin: 0 auto;
    }
    h1 {
      margin: 0 0 6px 0;
      text-align: center;
      font-size: 28px;
      letter-spacing: 0.2px;
    }
    .sub {
      text-align: center;
      color: var(--muted);
      margin-bottom: 18px;
      font-size: 13px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--shadow);
      margin: 14px 0;
    }
    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    .field {
      flex: 1;
      min-width: 220px;
    }
    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px 0;
    }
    input, select {
      width: 100%;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      outline: none;
      font-size: 14px;
      box-sizing: border-box;
    }
    input:focus, select:focus {
      border-color: #c7d2fe;
      box-shadow: 0 0 0 4px rgba(99,102,241,0.12);
    }
    .btn {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
      white-space: nowrap;
    }
    .btnPrimary { background: var(--btn); color: var(--btnText); }
    .btnSecondary { background: var(--btn2); color: var(--btn2Text); border-color: var(--border); }
    .btnDanger { background: #fff; color: var(--danger); border-color: #fecaca; }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; }

    .hint {
      color: var(--muted);
      font-size: 12px;
      margin-top: 6px;
    }

    .bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    pre {
      background: #000;
      color: #0f0;
      padding: 12px;
      border-radius: 12px;
      min-height: 160px;
      overflow: auto;
      border: 1px solid #111;
      box-shadow: var(--shadow);
    }

    .statusLine {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
    }
    .pill.ok { border-color: #bbf7d0; color: var(--ok); }
    .pill.bad { border-color: #fecaca; color: var(--danger); }

    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Dad Profile</h1>
    <div class="sub">
      API: <span id="apiText"></span>
    </div>

    <!-- LOGIN -->
    <div id="loginCard" class="card">
      <div class="bar">
        <div style="flex:1; min-width: 240px;">
          <div class="row">
            <div class="field">
              <label for="familyCode">Family Code</label>
              <input id="familyCode" placeholder="Enter family code" autocomplete="off" />
              <div class="hint">This stores a token in your browser (localStorage).</div>
            </div>
            <button id="btnLogin" class="btn btnPrimary" onclick="login()">Login</button>
          </div>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="appCard" class="card hidden">
      <div class="bar">
        <div class="hint">
          Signed in as <b>dad01</b>
        </div>
        <div class="row" style="gap:10px;">
          <button id="btnLoad" class="btn btnSecondary" onclick="loadProfile()">Load</button>
          <button id="btnSave" class="btn btnPrimary" onclick="saveProfile()">Save</button>
          <button class="btn btnDanger" onclick="logout()">Logout</button>
        </div>
      </div>

      <hr style="border:none; border-top:1px solid var(--border); margin:14px 0;" />

      <div class="row">
        <div class="field">
          <label for="name">Name</label>
          <input id="name" placeholder="e.g. Dad" />
        </div>

        <div class="field" style="max-width: 220px;">
          <label for="lang">Language</label>
          <select id="lang">
            <option value="zh">Chinese (zh)</option>
            <option value="en">English (en)</option>
          </select>
        </div>
      </div>

      <div class="statusLine">
        <div class="pill" id="authPill">Auth: unknown</div>
        <div class="pill" id="profilePill">Profile: unknown</div>
      </div>
    </div>

    <!-- OUTPUT -->
    <pre id="output">Ready.</pre>
  </div>

<script>
  // ====== CONFIG ======
  const API_BASE = "https://olvu4z746i7cxbvaujekdfa2li0rrlym.lambda-url.us-west-2.on.aws";
  const USER_ID = "dad01";

  // ====== UI HOOKS ======
  const apiText = document.getElementById("apiText");
  const output = document.getElementById("output");

  const loginCard = document.getElementById("loginCard");
  const appCard = document.getElementById("appCard");

  const btnLogin = document.getElementById("btnLogin");
  const btnLoad = document.getElementById("btnLoad");
  const btnSave = document.getElementById("btnSave");

  const authPill = document.getElementById("authPill");
  const profilePill = document.getElementById("profilePill");

  const familyCodeEl = document.getElementById("familyCode");
  const nameEl = document.getElementById("name");
  const langEl = document.getElementById("lang");

  apiText.textContent = API_BASE;

  // ====== HELPERS ======
  function log(msg) {
    output.textContent = (typeof msg === "string") ? msg : JSON.stringify(msg, null, 2);
  }

  function setBusy(isBusy) {
    btnLogin.disabled = isBusy;
    btnLoad.disabled = isBusy;
    btnSave.disabled = isBusy;
  }

  function setAuthStatus(ok, text) {
    authPill.classList.remove("ok", "bad");
    authPill.classList.add(ok ? "ok" : "bad");
    authPill.textContent = `Auth: ${text}`;
  }

  function setProfileStatus(ok, text) {
    profilePill.classList.remove("ok", "bad");
    profilePill.classList.add(ok ? "ok" : "bad");
    profilePill.textContent = `Profile: ${text}`;
  }

  function getToken() {
    return localStorage.getItem("token");
  }

  function setToken(token) {
    localStorage.setItem("token", token);
  }

  function clearToken() {
    localStorage.removeItem("token");
  }

  function showApp() {
    loginCard.classList.add("hidden");
    appCard.classList.remove("hidden");
  }

  function showLogin() {
    appCard.classList.add("hidden");
    loginCard.classList.remove("hidden");
  }

  // Fetch wrapper that returns { ok, status, text, json? }
  async function fetchJson(url, options) {
    const res = await fetch(url, options);
    const text = await res.text(); // read raw first to avoid JSON parse crashes
    let json = null;
    if (text) {
      try { json = JSON.parse(text); } catch { /* keep json null */ }
    }
    return { ok: res.ok, status: res.status, text, json };
  }

  // ====== ACTIONS ======
  async function login() {
    const code = familyCodeEl.value.trim();
    if (!code) return log("Enter family code.");

    setBusy(true);
    setAuthStatus(false, "logging in...");
    setProfileStatus(false, "unknown");

    try {
      log("Logging in...");

      const r = await fetchJson(`${API_BASE}/auth/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code })
      });

      if (!r.json) {
        setAuthStatus(false, `bad response (${r.status})`);
        log(`Login response not JSON (status ${r.status}). Raw:\n${r.text}`);
        return;
      }

      if (!r.ok) {
        setAuthStatus(false, `HTTP ${r.status}`);
        log({ error: "Login HTTP error", status: r.status, body: r.json });
        return;
      }

      if (!r.json.ok || !r.json.token) {
        setAuthStatus(false, "failed");
        log({ error: "Login failed", body: r.json });
        return;
      }

      setToken(r.json.token);
      setAuthStatus(true, "ok");
      showApp();
      log("Login successful. Loading profile...");

      // Auto-load right after login
      await loadProfile();

    } catch (err) {
      setAuthStatus(false, "error");
      log(`Login error: ${err?.message || String(err)}`);
    } finally {
      setBusy(false);
    }
  }

  async function loadProfile() {
    const token = getToken();
    if (!token) {
      setAuthStatus(false, "missing token");
      showLogin();
      return log("Not logged in.");
    }

    setBusy(true);
    setAuthStatus(true, "ok");
    setProfileStatus(false, "loading...");

    try {
      log("Loading profile...");

      const r = await fetchJson(`${API_BASE}/profiles/get?userId=${encodeURIComponent(USER_ID)}`, {
        method: "GET",
        headers: { "Authorization": `Bearer ${token}` }
      });

      if (!r.json) {
        setProfileStatus(false, `bad response (${r.status})`);
        log(`Profile response not JSON (status ${r.status}). Raw:\n${r.text}`);
        return;
      }

      if (!r.ok) {
        // If token expired/invalid, force logout UX
        if (r.status === 401 || r.status === 403) {
          setAuthStatus(false, `unauthorized (${r.status})`);
          clearToken();
          showLogin();
        }
        setProfileStatus(false, `HTTP ${r.status}`);
        log({ error: "Load profile HTTP error", status: r.status, body: r.json });
        return;
      }

      if (!r.json.ok || !r.json.profile) {
        setProfileStatus(false, "not found");
        log({ error: "Profile not found or invalid", body: r.json });
        return;
      }

      // Support both shapes:
      // r.json.profile.profile (your screenshot)
      // OR r.json.profile (flat)
      const p = (r.json.profile.profile && typeof r.json.profile.profile === "object")
        ? r.json.profile.profile
        : r.json.profile;

      nameEl.value = p.name ?? "";
      langEl.value = p.lang ?? "zh";

      setProfileStatus(true, "loaded");
      log({ ok: true, loadedProfile: p });

    } catch (err) {
      setProfileStatus(false, "error");
      log(`Load profile error: ${err?.message || String(err)}`);
    } finally {
      setBusy(false);
    }
  }

  async function saveProfile() {
    const token = getToken();
    if (!token) {
      setAuthStatus(false, "missing token");
      showLogin();
      return log("Not logged in.");
    }

    const profile = {
      name: nameEl.value.trim(),
      lang: langEl.value
    };

    setBusy(true);
    setAuthStatus(true, "ok");
    setProfileStatus(false, "saving...");

    try {
      log("Saving profile...");

      const r = await fetchJson(`${API_BASE}/profiles/upsert`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ userId: USER_ID, profile })
      });

      if (!r.json) {
        setProfileStatus(false, `bad response (${r.status})`);
        log(`Save response not JSON (status ${r.status}). Raw:\n${r.text}`);
        return;
      }

      if (!r.ok) {
        if (r.status === 401 || r.status === 403) {
          setAuthStatus(false, `unauthorized (${r.status})`);
          clearToken();
          showLogin();
        }
        setProfileStatus(false, `HTTP ${r.status}`);
        log({ error: "Save profile HTTP error", status: r.status, body: r.json });
        return;
      }

      if (!r.json.ok) {
        setProfileStatus(false, "failed");
        log({ error: "Save profile failed", body: r.json });
        return;
      }

      setProfileStatus(true, "saved");
      log({ ok: true, saved: profile, response: r.json });

      // Optional: reload to confirm what DB returns
      await loadProfile();

    } catch (err) {
      setProfileStatus(false, "error");
      log(`Save profile error: ${err?.message || String(err)}`);
    } finally {
      setBusy(false);
    }
  }

  function logout() {
    clearToken();
    setAuthStatus(false, "logged out");
    setProfileStatus(false, "unknown");
    showLogin();
    log("Logged out.");
  }

  // ====== BOOT ======
  (async function boot() {
    const token = getToken();
    if (token) {
      showApp();
      setAuthStatus(true, "token found");
      log("Token found. Loading profile...");
      await loadProfile();
    } else {
      showLogin();
      setAuthStatus(false, "not logged in");
      setProfileStatus(false, "unknown");
    }
  })();
</script>
</body>
</html>
